

properties:

  - target:		motto_mysql
  #- mysql_ruby_version: '2.7.4'
  #- mysql_ruby_version: '2.7.5'
  #- mysql_ruby_version: '2.7.6'
  #- mysql_ruby_version: '2.8pre4'
  - mysql_ruby_version: '2.8'
  - mysql_srcdir:	external/mysql-ruby-$(mysql_ruby_version)
  - mysql_c:		$(mysql_srcdir)/mysql.c

recipes:

  - product:	:all
    ingreds:	[ Makefile, $(target).h ]
    method*: |
	sys "make"

  - product:	:clean
    method*: |
	rm_rf 'Makefile', '$(target).h', '$(target).o', '$(target).bundle', 'debug', 'mkmf.log'

  - product:	ext/Makefile
    ingreds:	[ ext/extconf.rb ]
    method*: |
	chdir "ext" do
	  #sys "ruby extconf.rb --with-mysql-dir=/usr/local/mysql"
	  #sys "ruby extconf.rb --with-mysql-config"
	  sys "ruby extconf.rb"
	end

  - product:	:header
    ingreds:	[ ext/$(target).h ]

  - product:	ext/$(target).h
    ingreds:	[ $(mysql_c), Rookbook.yaml ]
    method*: |
	source = File.read('$(mysql_c)')
	s = ''
	s << "/* ------------------------ copied from mysql.c ------------------------ */\n"
	s << "\n"
	s << (source =~ /^\#define MYSQL_RUBY_VERSION.*?\n/ and $&)
	s << "\n"
	s << "/* struct mysql_res */\n"
	s << (source =~ /^struct mysql_res \{.*?^\};\n/m and $&)
	s << "\n"
	s << "/* macro GetMysqlRes */\n"
	s << (source =~ /^\#define GetMysqlRes\(obj\).*?\n/ and $&)
	s << "\n"
	s << "/* struct mysql_stmt */\n"
	s << (source =~ /^struct mysql_stmt \{.*?\};\n/m and $&)
	s << "\n"
	s << "/* macro GetMysqlStmt */\n"
	s << (source =~ /^\#define GetMysqlStmt\(obj\).*?\n/ and $&)
	s << "\n"
	s << "/* check_free() */\n"
	s << (source =~ /^static void check_free\(VALUE \w+\)\n\{.*?^\}\n/m and $&)
	s << "\n"
	s << "/* check_stmt_closed() */\n"
	s << (source =~ /^static void check_stmt_closed\(VALUE \w+\)\n\{.*?^\}\n/m and $&)
	s << "\n"
	s << "/* mysql_stmt_raise() */\n"
	s << (source =~ /^static void mysql_stmt_raise\(MYSQL_STMT\* \w+\)\n\{.*?^\}\n/m and $&)
	s << "\n"
	s << "/* --------------------------------------------------------------------- */\n"
	File.open(@product, 'w') {|f| f.write(s) }


  - product:	README.html
    ingreds:	[ README.rdoc ]
    method*: |
	#sys "rd2 #{@ingred} > #{@product}"
	#sys "rdoc -1 #{@ingred} > #{@product}"
	#sys "rdoc #{@ingred}"
	sys "rdoc --template hefss  #{@ingred}"
	#sys "rdoc --template kilmer #{@ingred}"
	mv "doc/files/README_rdoc.html", @product
	mv "doc/rdoc-style.css", "rdoc-style.css"
	rm_rf "doc"
	edit @product do |content|
	  content.sub! '<body bgcolor="#BBBBBB">', '<body>'
	  content.sub! 'href=".././rdoc-style.css"', 'href="rdoc-style.css"'
	  content
	end
	edit "rdoc-style.css" do |content|
	  content.sub! 'background: #BBBBBB;', '/*background: #BBBBBB;*/'
	  content << "\n"
	  content << "dt { font-weight: bold; color: #000000; margin-top: 5px; }\n"
	  content << "dd { margin-top: 5px; margin-bottom: 10px; }\n"
	end

  - product:	:debug
    method*: |
	items = %w[string var_string int24 long longlong float double
	           timestamp datetime date time
		   tiny short year decimal blob tiny_blob medium_blob newdecimal bit]
	s = ''
	s <<   "#if DEBUG\n"
	s <<   "    int _type = buffer_type;\n"
	s <<   "    int _length = s->result.length[i];\n"
	s <<   "    switch (_type) {\n"
	for item in items
	  t = item.upcase
	  s << "    case MYSQL_TYPE_#{t}: fprintf(stderr, \"*** debug: MYSQL_TYPE_#{t}(%d), length=%d\\n\", _type, _length); break;\n"
	end
	s <<   "    default:  fprintf(stderr, \"*** debug: unknown type(%d)\\n\", _type);\n"
	s <<   "    }\n"
	s <<   "#endif\n"
	File.open('debug', 'w') {|f| f << s }
